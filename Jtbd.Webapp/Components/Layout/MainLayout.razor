@using Jtbd.Application.Interfaces
@using Jtbd.Domain.Entities
@using Jtbd.Webapp.Service
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider authenticationStateProvider
@inject IJSRuntime JS

@inherits LayoutComponentBase

@if (!string.IsNullOrEmpty(username))
{
    <div class="page">
        <div class="sidebar" id="sidebardemo">
            <div class="sidebar-content">
                @if (!string.IsNullOrEmpty(username))
                {
                    <NavMenu @key="sessionKey" />
                }
            </div>            
        </div>

        <div class="main-content" id="maindemo" style="width:100%">
            <main>
                <div class="row">
                    <div class="col-lg-6">
                        <p>
                            <h5><strong>&nbsp;&nbsp;&nbsp;&nbsp;JTBD WEB APP – Empresas Polar</strong></h5>
                        </p>
                    </div>
                    <div class="col-lg-5 d-flex justify-content-end mb-3">
                        <strong>@usernamelargo</strong>
                    </div>
                </div>

                <article class="content px-4">
                    @Body
                </article>
            </main>
        </div>
    </div>

    <div id="blazor-error-ui" data-nosnippet>
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">🗙</span>
    </div>

    @if (mostrarAlerta)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" id="divAlerta">
            @mensajeAlerta
            <button type="button" class="btn-close" @onclick="() => mostrarAlerta = false"></button>
        </div>
    }
}
else
{
    <PageTitle>No Autorizado</PageTitle>
    <div class="row align-content-center">
        <div class="col-lg-11">
             <div class="col-lg-11">
                <h3 class="text-center mt-4">No Autorizado</h3>
                <h6>@usernamelargo</h6>
                <h6>@username</h6>
            </div>
        </div>
    </div>
}

@code{
    private string username = "dusa-user"; // Ojo: esto hardcodeado hará que se renderice antes de auth
    private string usernamelargo = "dusa-user";
    private int userdepart = 0;
    private int userrol = 0;
    private string? mensajeAlerta;
    private bool mostrarAlerta = false;
    private bool cargando = false;
    private Guid sessionKey = Guid.NewGuid();

    [Inject] private NavigationManager NavigationManager { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        cargando = true;
        try
        {
            var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity != null && authState.User.Identity.IsAuthenticated)
            {
                usernamelargo = authState.User.Identity.Name ?? "";
                var splitName = authState.User.Identity.Name?.Split(@"\");
                if (splitName != null && splitName.Length > 1)
                {
                    username = splitName[1].Trim();
                    NotificarCambio();
                }
            }
        }
        catch (Exception ex)
        {
            mensajeAlerta = ex.Message;
            mostrarAlerta = true;
        }
        cargando = false;
    }

    private void NotificarCambio()
    {
        sessionKey = Guid.NewGuid(); // Cambiamos la clave
        StateHasChanged();           // Forzamos el render del Layout
    }
}

<script>
    window.initSidebarState = function() {
        var estado = localStorage.getItem('sidebarState');
        var sidebar = document.getElementById("sidebardemo");
        var mainContent = document.getElementById("maindemo");

        if (sidebar && mainContent) {
            // Obtenemos el contenedor del botón y el botón mismo
            var contenedorBoton = document.getElementById('slideBoton');
            var boton = document.getElementById('menuToggle');

            if (estado === "collapsed") {
                sidebar.classList.add("collapsed");
                mainContent.classList.add("expanded");

                // --- AJUSTE PARA EL BOTÓN CENTRADO ---
                if (contenedorBoton) {
                    // Forzamos el centrado con Flexbox eliminando paddings
                    contenedorBoton.classList.add('d-flex', 'justify-content-center', 'p-0');
                    contenedorBoton.style.width = '100%';
                }
                if (boton) {
                    // Quitamos el posicionamiento absoluto y cualquier margen lateral
                    boton.style.position = 'static';
                    boton.style.margin = '0 auto';
                }
                // -------------------------------------

                var miDiv = document.getElementById('divtexto');
                var miDiv2 = document.getElementById('diviconos');
                var miDiv3 = document.getElementById('imgLogo');

                if(miDiv) miDiv.style.display = 'none';
                if(miDiv2) miDiv2.style.display = 'block';
                if(miDiv3) miDiv3.style.display = 'none';

            } else {
                sidebar.classList.remove("collapsed");
                mainContent.classList.remove("expanded");

                // Revertir estilos cuando NO esté colapsado
                if (contenedorBoton) {
                    contenedorBoton.classList.remove('justify-content-center');
                    contenedorBoton.classList.add('d-flex', 'justify-content-end', 'p-0');
                }
                if (boton) {
                    boton.style.position = ''; // Vuelve al estilo original del CSS
                    boton.style.margin = '';
                }
            }
        }
    };


    // Intentamos correrlo inmediatamente por si el HTML ya existe
    window.initSidebarState();

    window.toggleBootstrapCollapse = function() {
        var sidebar = document.getElementById("sidebardemo");
        var mainContent = document.getElementById("maindemo");
        var contenedorBoton = document.getElementById('slideBoton');
        var boton = document.getElementById('menuToggle'); // Necesitamos el botón

        var miDiv = document.getElementById('divtexto');
        var miDiv2 = document.getElementById('diviconos');
        var miDiv3 = document.getElementById('imgLogo');

        if (sidebar && mainContent) {
            sidebar.classList.toggle("collapsed");
            mainContent.classList.toggle("expanded");

            var isCollapsed = sidebar.classList.contains('collapsed');

            // Guardar estado
            localStorage.setItem('sidebarState', isCollapsed ? 'collapsed' : 'expanded');

            // Visibilidad de elementos
            if(miDiv) miDiv.style.display = isCollapsed ? 'none' : 'block';
            if(miDiv2) miDiv2.style.display = isCollapsed ? 'block' : 'none';
            if(miDiv3) miDiv3.style.display = isCollapsed ? 'none' : 'block';

            // ALINEACIÓN ACORDE AL INIT
            if (contenedorBoton) {
                // Aseguramos que el padre ocupe el 100%
                // if (contenedorBoton.parentElement) {
                //     contenedorBoton.parentElement.style.width = '100%';
                //     contenedorBoton.parentElement.classList.remove('ps-3'); // Quita padding de Blazor
                // }

                if (isCollapsed) {
                    // Mismo comportamiento que tu Init: CENTRADO
                    contenedorBoton.classList.remove('justify-content-end');
                    contenedorBoton.classList.add('d-flex', 'justify-content-center', 'p-0');

                    if (boton) {
                        boton.style.position = 'static';
                        boton.style.margin = '0 auto';
                    }
                } else {
                    // Mismo comportamiento que tu Init: DERECHA
                    contenedorBoton.classList.remove('justify-content-center');
                    contenedorBoton.classList.add('d-flex', 'justify-content-end', 'p-0', 'm-2');

                    if (boton) {
                        boton.style.position = 'static';
                        boton.style.margin = '0';
                    }
                }
            }
        }
    };


    // Helper para timeouts
    window.TimeoutHelper = {
        showAndHide: function (elementId, timeoutMs) {
            const divElement = document.getElementById(elementId);
            if (divElement) {
                divElement.style.display = 'block';
                setTimeout(function () {
                    divElement.style.display = 'none';
                }, timeoutMs);
            }
        }
    };
</script>